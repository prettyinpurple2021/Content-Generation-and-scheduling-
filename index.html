<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Content Creator (Neon DB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .toast {
            visibility: hidden; opacity: 0; min-width: 250px;
            margin-left: -125px; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 50;
            left: 50%; bottom: 30px; transition: visibility 0s, opacity 0.5s linear;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .toast.show { visibility: visible; opacity: 1; }
        .suggestion-card {
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 bg-gradient-to-br from-gray-900 via-black to-purple-900">

    <div class="container mx-auto max-w-7xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                Social Media Scheduler
            </h1>
            <p class="text-lg text-gray-400 mt-2">Craft, Generate, and Schedule your content with AI.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Editor & AI Generator -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                <!-- Content Editor -->
                <div class="bg-gray-800/60 backdrop-blur-sm border border-purple-700/30 p-6 rounded-xl shadow-2xl shadow-purple-900/20">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-purple-400">Create Post</h2>
                    <div class="mb-4">
                        <label for="post-content" class="block text-sm font-medium text-gray-400 mb-2">Content</label>
                        <textarea id="post-content" rows="8" class="w-full p-3 bg-gray-900/70 border border-gray-700 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-gray-200 placeholder-gray-500 transition" placeholder="What's on your mind?"></textarea>
                        <p id="char-count" class="text-sm text-gray-500 text-right mt-1">0/2200</p>
                    </div>
                    <div class="mb-4">
                        <label for="image-url" class="block text-sm font-medium text-gray-400 mb-2">Image URL (Optional)</label>
                        <input type="url" id="image-url" class="w-full p-3 bg-gray-900/70 border border-gray-700 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-gray-200 placeholder-gray-500 transition" placeholder="https://example.com/image.png">
                    </div>
                    <div class="mb-4">
                        <label for="schedule-datetime" class="block text-sm font-medium text-gray-400 mb-2">Schedule Date & Time</label>
                        <input type="datetime-local" id="schedule-datetime" class="w-full p-3 bg-gray-900/70 border border-gray-700 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-gray-200 placeholder-gray-500 transition">
                    </div>
                    <button id="schedule-button" class="w-full bg-gradient-to-r from-purple-600 to-blue-500 text-white font-bold py-3 px-4 rounded-md hover:from-purple-700 hover:to-blue-600 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500">
                        Schedule Post
                    </button>
                </div>
                
                 <!-- AI Content Generator -->
                <div class="bg-gray-800/60 backdrop-blur-sm border border-purple-700/30 p-6 rounded-xl shadow-2xl shadow-purple-900/20">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-purple-400">AI Content Generator</h2>
                    <p class="text-gray-400 text-sm mb-4">Need inspiration? Let AI generate some post ideas for you.</p>
                    
                    <div class="mb-4">
                        <label for="platform-select" class="block text-sm font-medium text-gray-400 mb-2">Target Platform</label>
                        <select id="platform-select" class="w-full p-3 bg-gray-900/70 border border-gray-700 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-gray-200 transition">
                            <option value="General">General / Any</option>
                            <option value="X (Twitter)">X (Twitter)</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Bluesky">Bluesky</option>
                        </select>
                    </div>

                    <button id="generate-button" class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold py-3 px-4 rounded-md hover:from-green-600 hover:to-teal-600 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-green-500">
                        âœ¨ Generate Ideas
                    </button>
                </div>
            </div>

            <!-- Right Column: Previews and Lists -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <!-- AI Suggestions -->
                <div id="ai-suggestions-container" class="hidden bg-gray-800/60 backdrop-blur-sm border border-purple-700/30 p-6 rounded-xl shadow-2xl shadow-purple-900/20">
                     <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-purple-400">Generated Ideas</h2>
                     <div id="ai-suggestions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- AI suggestions will be injected here -->
                     </div>
                </div>

                <!-- Live Preview -->
                <div class="bg-gray-800/60 backdrop-blur-sm border border-purple-700/30 p-6 rounded-xl shadow-2xl shadow-purple-900/20">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-purple-400">Live Preview</h2>
                    <div id="preview-card" class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <img src="https://placehold.co/40x40/8B5CF6/FFFFFF?text=Y" alt="User Avatar" class="w-10 h-10 rounded-full mr-3 border-2 border-purple-500">
                            <div>
                                <p class="font-bold text-gray-100">Your Name</p>
                                <p class="text-sm text-gray-400">@yourhandle</p>
                            </div>
                        </div>
                        <p id="preview-content" class="text-gray-300 whitespace-pre-wrap min-h-[4em]">Your post content will appear here...</p>
                        <img id="preview-image" src="" alt="Post image" class="hidden mt-3 rounded-lg w-full h-auto object-cover border border-gray-700">
                    </div>
                </div>
                
                <!-- Scheduled Posts -->
                <div class="bg-gray-800/60 backdrop-blur-sm border border-purple-700/30 p-6 rounded-xl shadow-2xl shadow-purple-900/20">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2 text-purple-400">Scheduled Posts</h2>
                    <div id="scheduled-posts-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <p class="text-gray-500">Loading scheduled posts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = 'http://localhost:3000/api';
        const GEMINI_API_KEY = ""; // Use "" for Canvas-provided key
        const platformLimits = {
            "General": 2200,
            "X (Twitter)": 280,
            "LinkedIn": 3000,
            "Instagram": 2200,
            "Facebook": 5000,
            "Bluesky": 300
        };

        // --- DOM Elements ---
        const postContent = document.getElementById('post-content');
        const imageUrl = document.getElementById('image-url');
        const scheduleDatetime = document.getElementById('schedule-datetime');
        const scheduleButton = document.getElementById('schedule-button');
        const charCount = document.getElementById('char-count');
        const previewContent = document.getElementById('preview-content');
        const previewImage = document.getElementById('preview-image');
        const scheduledPostsList = document.getElementById('scheduled-posts-list');
        const toast = document.getElementById('toast');
        const generateButton = document.getElementById('generate-button');
        const platformSelect = document.getElementById('platform-select');
        const aiSuggestionsContainer = document.getElementById('ai-suggestions-container');
        const aiSuggestions = document.getElementById('ai-suggestions');

        // --- Event Listeners ---
        postContent.addEventListener('input', updatePreview);
        imageUrl.addEventListener('input', updatePreview);
        scheduleButton.addEventListener('click', handleSchedulePost);
        generateButton.addEventListener('click', handleGenerateContent);
        platformSelect.addEventListener('change', updatePreview);

        // --- Functions ---
        function updatePreview() {
            const content = postContent.value;
            const selectedPlatform = platformSelect.value;
            const limit = platformLimits[selectedPlatform] || 2200;

            charCount.textContent = `${content.length}/${limit}`;
            charCount.classList.toggle('text-red-400', content.length > limit);
            previewContent.textContent = content || "Your post content will appear here...";
            
            const imgUrl = imageUrl.value;
            if (imgUrl.trim()) {
                previewImage.src = imgUrl;
                previewImage.classList.remove('hidden');
                previewImage.onerror = () => previewImage.classList.add('hidden');
            } else {
                previewImage.classList.add('hidden');
            }
        }

        async function handleSchedulePost() {
            const content = postContent.value.trim();
            const image_url = imageUrl.value.trim();
            const schedule_time = scheduleDatetime.value;
            const selectedPlatform = platformSelect.value;
            const limit = platformLimits[selectedPlatform] || 2200;

            if (content.length > limit) {
                showToast(`Post exceeds the character limit for ${selectedPlatform}.`, "error");
                return;
            }

            if (!content || !schedule_time) {
                showToast("Content and schedule time are required.", "error");
                return;
            }
            const scheduleDate = new Date(schedule_time);
            if (scheduleDate <= new Date()) {
                showToast("Scheduled time must be in the future.", "error");
                return;
            }

            try {
                scheduleButton.disabled = true;
                scheduleButton.textContent = "Scheduling...";
                const response = await fetch(`${API_BASE_URL}/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, image_url, schedule_time })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to schedule post');
                }

                showToast("Post scheduled successfully!", "success");
                postContent.value = "";
                imageUrl.value = "";
                scheduleDatetime.value = "";
                updatePreview();
                fetchScheduledPosts();
            } catch (error) {
                console.error("Error scheduling post:", error);
                showToast(error.message, "error");
            } finally {
                scheduleButton.disabled = false;
                scheduleButton.textContent = "Schedule Post";
            }
        }

        async function fetchScheduledPosts() {
             try {
                const response = await fetch(`${API_BASE_URL}/posts`);
                if (!response.ok) throw new Error('Failed to fetch posts');
                
                const posts = await response.json();
                renderScheduledPosts(posts);
            } catch (error) {
                console.error("Error fetching posts:", error);
                scheduledPostsList.innerHTML = '<p class="text-red-400">Could not load posts.</p>';
            }
        }

        function renderScheduledPosts(posts) {
             if (posts.length === 0) {
                scheduledPostsList.innerHTML = '<p class="text-gray-500">No posts scheduled yet.</p>';
                return;
            }

            scheduledPostsList.innerHTML = '';
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-gray-900/50 p-3 rounded-lg border border-gray-700 flex justify-between items-center transition-all hover:border-purple-500';
                
                const scheduleDate = new Date(post.schedule_time);
                const formattedDate = scheduleDate.toLocaleString([], {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                postElement.innerHTML = `
                    <div>
                        <p class="font-medium truncate text-gray-200">${post.content}</p>
                        <p class="text-sm text-purple-400">${formattedDate}</p>
                    </div>
                    <button onclick="deletePost(${post.id})" class="delete-btn text-gray-500 hover:text-pink-500 font-bold text-2xl p-1 transition-colors">&times;</button>
                `;
                scheduledPostsList.appendChild(postElement);
            });
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this scheduled post?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete post');
                
                showToast("Post deleted successfully!", "success");
                fetchScheduledPosts();
            } catch (error) {
                console.error("Error deleting post:", error);
                showToast(error.message, "error");
            }
        }

        async function handleGenerateContent() {
            const selectedPlatform = platformSelect.value;
            generateButton.disabled = true;
            generateButton.innerHTML = `
                <svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generating for ${selectedPlatform}...`;
            aiSuggestionsContainer.classList.remove('hidden');
            aiSuggestions.innerHTML = '<p class="text-gray-400 md:col-span-2 text-center">AI is thinking...</p>';

            const systemPrompt = `You are an expert social media marketer for SaaS startups. Your target audience is solo entrepreneurs, solo founders, and small business owners.

            Your task is to generate 3 distinct social media posts tailored for the ${selectedPlatform} platform.

            Rules:
            1.  **Platform Specificity**: Adapt the tone, length, and format for ${selectedPlatform}.
                - For "X (Twitter)", be concise (under 280 characters) and use 1-2 relevant hashtags.
                - For "LinkedIn", use a professional and slightly longer format, focusing on business insights. Use professional hashtags.
                - For "Instagram", write an engaging caption, use multiple relevant hashtags (5-7), and suggest a visually compelling image.
                - For "Facebook", adopt a conversational and friendly tone. Posts can be longer and should encourage discussion or ask questions.
                - For "Bluesky", keep posts concise (under 300 characters) with a casual, witty, or conversational tone. Hashtags are less common but can be used.
                - For "General", create a versatile post that could work on most platforms.
            2.  Each post must focus on a different, relevant topic for the target audience (e.g., productivity hacks, marketing tips, financial management, work-life balance, scaling).
            3.  Each post must include a subtle, natural-sounding call to action promoting a fictional SaaS product called "SoloSuccess AI". Frame it as a tool that helps with the problem mentioned in the post.
            4.  Do NOT mention or suggest any other AI or SaaS products. Only promote "SoloSuccess AI".
            5.  For each post, provide a realistic, high-quality, and royalty-free image URL from a stock photo provider like Unsplash or Pexels. The image must be relevant to the post's topic.
            6.  The response MUST be a valid JSON array of objects.`;

            const payload = {
                contents: [{ parts: [{ text: "Generate 3 social media posts." }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "topic": { "type": "STRING" },
                                "post_text": { "type": "STRING" },
                                "image_url": { "type": "STRING" }
                            },
                            required: ["topic", "post_text", "image_url"]
                        }
                    }
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                   throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("No content received from AI.");
                }
                const generatedPosts = JSON.parse(jsonText);
                renderSuggestions(generatedPosts);

            } catch (error) {
                console.error("Error generating content:", error);
                aiSuggestions.innerHTML = `<p class="text-red-400 md:col-span-2 text-center">Failed to generate ideas. Please try again. Error: ${error.message}</p>`;
                showToast("AI generation failed.", "error");
            } finally {
                generateButton.disabled = false;
                generateButton.innerHTML = "âœ¨ Generate Ideas";
            }
        }
        
        function renderSuggestions(posts) {
            aiSuggestions.innerHTML = '';
            if (!posts || posts.length === 0) {
                 aiSuggestions.innerHTML = '<p class="text-gray-500 md:col-span-2 text-center">No suggestions were generated.</p>';
                 return;
            }

            posts.forEach((post, index) => {
                const card = document.createElement('div');
                card.className = 'suggestion-card bg-gray-900/50 p-4 rounded-lg border border-gray-700 flex flex-col justify-between';
                card.style.animationDelay = `${index * 150}ms`;

                card.innerHTML = `
                    <div>
                        <img src="${post.image_url}" alt="${post.topic}" class="w-full h-32 object-cover rounded-md mb-3" onerror="this.style.display='none'">
                        <h4 class="font-semibold text-purple-400 mb-1">${post.topic}</h4>
                        <p class="text-sm text-gray-300 whitespace-pre-wrap">${post.post_text}</p>
                    </div>
                    <button class="use-idea-btn mt-4 w-full bg-purple-600 text-white text-sm font-bold py-2 px-3 rounded-md hover:bg-purple-700 transition-all">
                        Use this Idea
                    </button>
                `;
                
                card.querySelector('.use-idea-btn').addEventListener('click', () => {
                    postContent.value = post.post_text;
                    imageUrl.value = post.image_url;
                    updatePreview();
                    showToast("Content populated in the editor!", "success");
                });

                aiSuggestions.appendChild(card);
            });
        }


        function showToast(message, type = "info") {
            toast.textContent = message;
            let theme_class = 'bg-gray-700';
            if (type === 'success') theme_class = 'bg-green-500';
            if (type === 'error') theme_class = 'bg-red-500';
            toast.className = `toast show ${theme_class}`;
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            updatePreview();
            fetchScheduledPosts();
        });
    </script>
</body>
</html>


